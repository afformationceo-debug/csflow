# RAG 파이프라인 End-to-End 테스트 가이드

## 목적
실제 LINE 메시지를 통해 RAG 파이프라인의 전체 흐름을 검증합니다:
1. 지식베이스 검색 → AI 자동 응답
2. 지식 부족 감지 → 에스컬레이션 (KB 업데이트 추천)
3. 거래처 정보 쿼리 → 에스컬레이션 (Tenant DB 업데이트 추천)
4. 에스컬레이션 감소 효과 (KB 업데이트 후 재테스트)

---

## 사전 준비

### 1. LINE 채널 설정 확인
- LINE Developers Console에서 Webhook URL 확인:
  - URL: `https://csflow.vercel.app/api/webhooks/line`
  - "Use webhook" 토글 ON
  - "Verify" 버튼 클릭 → 200 OK 응답 확인

### 2. 채널 관리 페이지에서 LINE 채널 등록 확인
- https://csflow.vercel.app/channels
- LINE 채널이 활성화되어 있는지 확인
- Tenant: "CS Command Center" 또는 실제 거래처명

### 3. LINE 앱에서 봇 추가
- LINE 앱에서 Bot Basic ID(@246kdolz) 검색하여 추가
- 또는 QR 코드 스캔

---

## 테스트 시나리오

### 🧪 Test 1: 지식베이스 쿼리 (AI 자동 응답)

**목표**: 기존 지식베이스에 있는 FAQ 질문 → AI가 자동으로 응답

#### 1단계: LINE 메시지 전송
LINE 앱에서 다음 메시지 전송:
```
라식 수술 가격이 얼마인가요?
```

#### 2단계: 예상 결과 확인
- ✅ AI가 자동으로 답변 (2-5초 이내)
- ✅ 답변 내용에 가격 정보 포함
- ✅ 에스컬레이션 생성 안 됨

#### 3단계: 에스컬레이션 페이지 확인
- https://csflow.vercel.app/escalations
- 새로운 에스컬레이션이 **생성되지 않아야 함**
- (이미 있던 에스컬레이션만 표시됨)

---

### 🧪 Test 2: 지식 부족 (KB 업데이트 추천)

**목표**: 지식베이스에 없는 질문 → 에스컬레이션 + KB 업데이트 추천

#### 1단계: LINE 메시지 전송
LINE 앱에서 다음 메시지 전송:
```
스마일라식 회복 기간은 얼마나 걸리나요?
```

#### 2단계: 예상 결과 확인
- ❌ AI가 즉시 답변하지 못함
- ✅ 에스컬레이션 생성됨 (30초 이내)

#### 3단계: 에스컬레이션 페이지 확인
https://csflow.vercel.app/escalations

**확인 사항**:
1. **고객 질문** 섹션:
   - ✅ 실제 고객이 보낸 메시지 표시: "스마일라식 회복 기간은 얼마나 걸리나요?"
   - ✅ 내부 대화 메시지 **표시 안 됨** (예: "이 분은 특별 관리 필요")

2. **AI 요청** 섹션:
   - ✅ 추천 액션: **"지식베이스 업데이트"** 배지 (파란색)
   - ✅ 누락 정보: "관련 FAQ 문서", "일반적인 답변 가이드" 등

3. **업데이트 버튼**:
   - ✅ "지식베이스 업데이트" 버튼 클릭 가능
   - ✅ 다이얼로그 열림, 예시 텍스트 미리 채워짐

---

### 🧪 Test 3: 거래처 정보 쿼리 (Tenant DB 업데이트 추천)

**목표**: 거래처 운영 정보 질문 → 에스컬레이션 + Tenant DB 업데이트 추천

#### 1단계: LINE 메시지 전송
LINE 앱에서 다음 메시지 전송:
```
영업 시간이 언제인가요?
```

#### 2단계: 예상 결과 확인
- ❌ AI가 즉시 답변하지 못함
- ✅ 에스컬레이션 생성됨 (30초 이내)

#### 3단계: 에스컬레이션 페이지 확인
https://csflow.vercel.app/escalations

**확인 사항**:
1. **고객 질문** 섹션:
   - ✅ "영업 시간이 언제인가요?" 표시

2. **AI 요청** 섹션:
   - ✅ 추천 액션: **"거래처 정보 업데이트"** 배지 (주황색)
   - ✅ 누락 정보: "영업 시간"

3. **업데이트 버튼**:
   - ✅ "거래처 정보 업데이트" 버튼 클릭 가능
   - ✅ 다이얼로그 열림, 7개 필드 타입 선택 가능

---

### 🧪 Test 4: 에스컬레이션 감소 효과 (KB 업데이트 후)

**목표**: KB 업데이트 후 동일 질문 재전송 → AI 자동 응답

#### 1단계: 지식베이스 문서 추가
https://csflow.vercel.app/knowledge

**문서 내용**:
- **제목**: `스마일라식 회복 기간 안내`
- **카테고리**: `FAQ`
- **내용**:
```
스마일라식 수술 후 회복 기간은 일반적으로 다음과 같습니다:

- 수술 당일: 약간의 눈물, 이물감, 시력 흐림 현상이 있을 수 있습니다.
- 1-2일: 대부분의 불편감이 사라지며, 일상생활 복귀가 가능합니다.
- 1주일: 시력이 안정화되기 시작합니다. 운전 등 일상 활동 가능.
- 1개월: 대부분의 환자가 최종 시력에 도달합니다.
- 3개월: 완전한 회복 및 안정화 단계입니다.

주의사항:
- 수술 후 1주일간 눈에 물이 들어가지 않도록 주의
- 렌즈 착용 금지 (의사 지시에 따라)
- 정기 검진 필수 (1일, 1주일, 1개월, 3개월)
```
- **태그**: `스마일라식`, `회복기간`, `수술후관리`

**저장 후 "임베딩 생성" 버튼 클릭** ✅

#### 2단계: 30초 대기
벡터 인덱스 업데이트 대기 (약 30초)

#### 3단계: 동일한 질문 재전송
LINE 앱에서 다시 전송:
```
스마일라식 회복 기간은 얼마나 걸리나요?
```

#### 4단계: 예상 결과 확인
- ✅ AI가 자동으로 답변 (2-5초 이내)
- ✅ 답변 내용에 회복 기간 정보 포함 (1-2일, 1주일, 1개월, 3개월 등)
- ✅ 에스컬레이션 생성 안 됨

#### 5단계: 에스컬레이션 페이지 확인
https://csflow.vercel.app/escalations

**확인 사항**:
- ✅ 새로운 에스컬레이션이 **생성되지 않음**
- ✅ 기존 "스마일라식 회복 기간" 에스컬레이션 1건만 존재
- ✅ **에스컬레이션 감소 효과 확인 완료** 🎉

---

## 최종 체크리스트

### ✅ 고객 질문 표시 검증
- [ ] 에스컬레이션 페이지에서 실제 고객 메시지가 표시됨
- [ ] 내부 대화 메시지가 표시되지 않음
- [ ] 원문(일본어/영어 등) + 한국어 번역 형식으로 표시됨

### ✅ AI 추천 로직 검증
- [ ] 지식베이스 쿼리 → 자동 응답 (에스컬레이션 없음)
- [ ] 지식 부족 → "지식베이스 업데이트" 추천
- [ ] 거래처 정보 쿼리 → "거래처 정보 업데이트" 추천

### ✅ DB 연동 검증
- [ ] 지식베이스 문서 추가 → 임베딩 생성 → DB 저장 완료
- [ ] 거래처 설정 업데이트 → `tenants.settings` JSONB 병합 저장

### ✅ 에스컬레이션 감소 효과 검증
- [ ] KB 업데이트 전: 동일 질문 → 에스컬레이션 생성
- [ ] KB 업데이트 후: 동일 질문 → AI 자동 응답
- [ ] 에스컬레이션 건수 증가 없음 ✅

---

## 문제 발생 시 디버깅

### 1. 고객 질문에 내부 대화가 표시되는 경우
**원인**: 내부 노트가 `sender_type: "internal_note"`로 저장되지 않았거나, 필터링 로직 미적용

**해결**: 커밋 `961bb61` 배포 확인
- `/api/escalations` GET 엔드포인트 수정 완료
- `sender_type !== "internal_note", "system", "agent"` 필터링 적용
- 오름차순 정렬로 첫 번째 고객 메시지 우선 추출

### 2. AI가 자동 응답하지 않는 경우
**원인**:
- AI 활성화 OFF
- 지식베이스 문서 없음
- 임베딩 미생성

**해결**:
- 인박스에서 "AI 자동응대" 토글 ON 확인
- 지식베이스 페이지에서 문서 추가
- "임베딩 생성" 버튼 클릭 후 30초 대기

### 3. 에스컬레이션이 생성되지 않는 경우
**원인**:
- 신뢰도 임계값 너무 낮음 (default: 0.75)
- RAG 파이프라인 미실행

**해결**:
- 거래처 관리 → AI 설정 → 신뢰도 임계값 확인
- LINE 웹훅 로그 확인 (Vercel 대시보드)

---

## 성공 기준

✅ **All Tests Passed**:
1. Test 1: AI 자동 응답 성공 (에스컬레이션 없음)
2. Test 2: 에스컬레이션 생성 + KB 추천
3. Test 3: 에스컬레이션 생성 + Tenant DB 추천
4. Test 4: KB 업데이트 후 AI 자동 응답 (에스컬레이션 없음)

✅ **고객 질문 표시 정확**:
- 실제 고객 메시지 표시
- 내부 대화 미표시

✅ **에스컬레이션 감소 효과 확인**:
- 같은 질문 반복 시 AI 자동 답변
- 에스컬레이션 건수 증가 없음
