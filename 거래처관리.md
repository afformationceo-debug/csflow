# ê±°ë˜ì²˜ ê´€ë¦¬ ê¸°ëŠ¥ ê°œë°œ ë¬¸ì„œ

## ğŸ“‹ ê°œìš”
CSFlow ê±°ë˜ì²˜ ê´€ë¦¬ ì‹œìŠ¤í…œ - ë³‘ì›/í´ë¦¬ë‹‰ ê±°ë˜ì²˜ ë“±ë¡, ìˆ˜ì •, ì‚­ì œ ë° AI ì„¤ì • ê´€ë¦¬

**ìµœì¢… ì—…ë°ì´íŠ¸**: 2026-02-03
**í…ŒìŠ¤íŠ¸ ìƒíƒœ**: âœ… ëª¨ë“  E2E í…ŒìŠ¤íŠ¸ í†µê³¼

---

## ğŸ¯ ì£¼ìš” ê¸°ëŠ¥

### 1. ê±°ë˜ì²˜ CRUD
- **ìƒì„±**: API POST `/api/tenants`
- **ì¡°íšŒ**: API GET `/api/tenants`
- **ìˆ˜ì •**: API PATCH `/api/tenants`
- **ì‚­ì œ**: API DELETE `/api/tenants?id={id}`

### 2. ë°ì´í„° êµ¬ì¡°

#### ê±°ë˜ì²˜ í•„ë“œ
```typescript
interface Tenant {
  id: string;                    // UUID
  name: string;                  // ê±°ë˜ì²˜ ID (ì˜ë¬¸, ì˜ˆ: bomon-clinic)
  display_name: string;          // í‘œì‹œ ì´ë¦„ (ì˜ˆ: ì²­ë‹´ë´„ì˜¨ì˜ì›)
  specialty: Specialty;          // ì§„ë£Œê³¼ëª©
  country?: string | null;       // êµ­ê°€
  status: "active" | "suspended";
  default_language: string;      // ê¸°ë³¸ ì–¸ì–´ (ko, en, ja, zh, zh-tw ë“±)
  ai_config: TenantAIConfig;
  settings: {
    default_language: string;
    country?: string | null;
  };
  stats: TenantStats;
  channels: TenantChannel[];
  created_at: string;
}
```

#### ì§„ë£Œê³¼ëª© (Specialty)
```typescript
type Specialty =
  | "ophthalmology"    // ì•ˆê³¼
  | "dentistry"        // ì¹˜ê³¼
  | "plastic_surgery"  // ì„±í˜•ì™¸ê³¼
  | "dermatology"      // í”¼ë¶€ê³¼
  | "general";         // ì¼ë°˜ì˜ì›
```

#### AI ì„¤ì •
```typescript
interface TenantAIConfig {
  preferred_model: string;           // "gpt-4", "gpt-4-turbo", "claude-3-opus" ë“±
  confidence_threshold: number;      // 0.0 ~ 1.0
  auto_response_enabled: boolean;    // ìë™ ì‘ëŒ€ í™œì„±í™”
  system_prompt: string;             // ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
  escalation_keywords: string[];     // ì—ìŠ¤ì»¬ë ˆì´ì…˜ í‚¤ì›Œë“œ
}
```

---

## ğŸ”§ API ìƒì„¸

### POST /api/tenants (ê±°ë˜ì²˜ ìƒì„±)

**Request Body**:
```json
{
  "name": "bomon-clinic",
  "display_name": "ì²­ë‹´ë´„ì˜¨ì˜ì›",
  "name_en": "Bomon Clinic",
  "specialty": "dermatology",
  "country": "ëŒ€ë§Œ",
  "default_language": "zh-tw"
}
```

**Response**:
```json
{
  "tenant": {
    "id": "uuid",
    "name": "bomon-clinic",
    "name_en": "Bomon Clinic",
    "specialty": "dermatology",
    "settings": {
      "default_language": "zh-tw",
      "country": "ëŒ€ë§Œ"
    },
    "ai_config": {
      "model": "gpt-4",
      "preferred_model": "gpt-4",
      "enabled": true,
      "auto_response_enabled": true,
      "confidence_threshold": 0.85,
      "system_prompt": "",
      "escalation_keywords": []
    },
    "created_at": "2026-02-03T06:38:21.183825+00:00"
  }
}
```

**ì¤‘ìš” ì‚¬í•­**:
- `display_name`ì€ í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì‚¬ìš©í•˜ì§€ë§Œ DBì—ëŠ” `name_en`ìœ¼ë¡œ ì €ì¥
- `country`ëŠ” `settings` JSONB í•„ë“œ ë‚´ë¶€ì— ì €ì¥
- `default_language`ë„ `settings`ì— ì €ì¥
- AI ì„¤ì •ì€ ê¸°ë³¸ê°’ìœ¼ë¡œ ìë™ ìƒì„±

---

## ğŸ¨ UI ì»´í¬ë„ŒíŠ¸

### í˜ì´ì§€ ìœ„ì¹˜
`/src/app/(dashboard)/tenants/page.tsx`

### ì£¼ìš” ì»´í¬ë„ŒíŠ¸

#### 1. ê±°ë˜ì²˜ ì¶”ê°€ ë‹¤ì´ì–¼ë¡œê·¸
```tsx
<Dialog>
  <DialogTrigger>
    <Button>ê±°ë˜ì²˜ ì¶”ê°€</Button>
  </DialogTrigger>
  <DialogContent>
    {/* í¼ í•„ë“œ */}
    <Input name="name" placeholder="healing-eye" />
    <Input name="display_name" placeholder="íë§ì•ˆê³¼" />
    <Select name="specialty">
      <SelectItem value="dermatology">í”¼ë¶€ê³¼</SelectItem>
      {/* ê¸°íƒ€ ì˜µì…˜ */}
    </Select>
    <Input name="country" placeholder="ì¼ë³¸, ëŒ€ë§Œ, ë² íŠ¸ë‚¨" />
    <Select name="default_language">
      <SelectItem value="zh-tw">ä¸­æ–‡ (å°ç£)</SelectItem>
      {/* ê¸°íƒ€ ì˜µì…˜ */}
    </Select>
  </DialogContent>
</Dialog>
```

#### 2. ê±°ë˜ì²˜ ì¹´ë“œ
```tsx
<Card className="group">
  <CardContent>
    {/* í—¤ë”: ì•„ë°”íƒ€, ì´ë¦„, ìƒíƒœ */}
    <div className="flex items-start justify-between">
      <div className="flex items-center gap-3">
        <Avatar>{displayName[0]}</Avatar>
        <div>
          <h3>{displayName}</h3>
          <Badge>{specialty}</Badge>
        </div>
      </div>

      {/* ì•¡ì…˜ ë²„íŠ¼ (í˜¸ë²„ ì‹œ í‘œì‹œ) */}
      <div className="opacity-0 group-hover:opacity-100">
        <Button title="ì„¤ì •"><Settings /></Button>
        <Button title="ì§€ì‹ë² ì´ìŠ¤"><BookOpen /></Button>
        <Button title="AI ì„¤ì •" onClick={openAIConfig}><Brain /></Button>
        <Button title="ì‚­ì œ" onClick={handleDeleteTenant}><Trash2 /></Button>
      </div>
    </div>

    {/* í†µê³„ */}
    <div className="grid grid-cols-4 gap-2">
      <StatCard label="AIì •í™•ë„" value={stats.ai_accuracy} />
      <StatCard label="ì´ ëŒ€í™”" value={stats.total_conversations} />
      <StatCard label="ì›” ë¬¸ì˜" value={stats.monthly_inquiries} />
      <StatCard label="ë§Œì¡±ë„" value={stats.csat_score} />
    </div>

    {/* AI ì„¤ì • íƒœê·¸ */}
    <div className="flex gap-1.5">
      <Badge>{ai_config.preferred_model}</Badge>
      <Badge>{ai_config.confidence_threshold * 100}%</Badge>
      <Badge>{ai_config.auto_response_enabled ? "ìë™ì‘ëŒ€ ON" : "OFF"}</Badge>
    </div>

    {/* ì±„ë„ ì •ë³´ */}
    <div className="flex items-center gap-1.5">
      {channels.map(ch => (
        <Badge key={ch.type}>{ch.type}</Badge>
      ))}
    </div>
  </CardContent>
</Card>
```

---

## ğŸ§ª E2E í…ŒìŠ¤íŠ¸

### í…ŒìŠ¤íŠ¸ íŒŒì¼
- `tests/e2e/tenant-management-fixed.spec.ts`
- **ëª¨ë“œ**: `serial` (ìˆœì°¨ ì‹¤í–‰)

### í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

#### 1ë‹¨ê³„: ëª¨ë“  ê±°ë˜ì²˜ ì‚­ì œ
```typescript
test("1ë‹¨ê³„: APIë¡œ ëª¨ë“  ê±°ë˜ì²˜ ì‚­ì œ", async ({ page }) => {
  await login(page);

  const response = await page.request.get(`${BASE_URL}/api/tenants`);
  const data = await response.json();

  for (const tenant of data.tenants) {
    await page.request.delete(`${BASE_URL}/api/tenants?id=${tenant.id}`);
  }

  // ì‚­ì œ í™•ì¸
  const checkResponse = await page.request.get(`${BASE_URL}/api/tenants`);
  expect(checkResponse.tenants.length).toBe(0);
});
```

#### 2ë‹¨ê³„: ìƒˆ ê±°ë˜ì²˜ ì¶”ê°€
```typescript
test("2ë‹¨ê³„: ìƒˆ ê±°ë˜ì²˜ ì¶”ê°€ (bomon-clinic)", async ({ page }) => {
  await login(page);
  await page.goto(`${BASE_URL}/tenants`);

  // ê±°ë˜ì²˜ ì¶”ê°€ ë²„íŠ¼ í´ë¦­
  const addButton = page.locator('button:has-text("ê±°ë˜ì²˜ ì¶”ê°€")');
  await addButton.first().click();

  // ë‹¤ì´ì–¼ë¡œê·¸ì—ì„œ í¼ ì…ë ¥
  await page.locator('input[placeholder*="healing-eye"]').fill("bomon-clinic");
  await page.locator('input[placeholder*="íë§ì•ˆê³¼"]').fill("ì²­ë‹´ë´„ì˜¨ì˜ì›");

  // Select ì»´í¬ë„ŒíŠ¸ - ì§„ë£Œê³¼ëª©
  await page.locator('[role="combobox"]').first().click();
  await page.locator('[role="option"]').filter({ hasText: "í”¼ë¶€ê³¼" }).click();

  // êµ­ê°€ ì…ë ¥
  await page.locator('input[placeholder*="ì¼ë³¸, ëŒ€ë§Œ, ë² íŠ¸ë‚¨"]').fill("ëŒ€ë§Œ");

  // Select ì»´í¬ë„ŒíŠ¸ - ê¸°ë³¸ ì–¸ì–´
  await page.locator('[role="combobox"]').nth(1).click();
  await page.locator('[role="option"]').filter({ hasText: /å°ç£/ }).click();

  // ì œì¶œ
  await page.locator('button[type="submit"]').click();

  // ëª©ë¡ì—ì„œ í™•ì¸
  await page.reload();
  await expect(page.locator('text=ì²­ë‹´ë´„ì˜¨ì˜ì›')).toBeVisible();
});
```

#### 3ë‹¨ê³„: Supabase ë°ì´í„° í™•ì¸
```typescript
test("3ë‹¨ê³„: Supabase ë°ì´í„° í™•ì¸", async ({ page }) => {
  await login(page);

  const response = await page.request.get(`${BASE_URL}/api/tenants`);
  const data = await response.json();

  const bomonClinic = data.tenants.find(
    t => t.name === "bomon-clinic"
  );

  expect(bomonClinic).toBeDefined();
  expect(bomonClinic.display_name).toBe("ì²­ë‹´ë´„ì˜¨ì˜ì›");
  expect(bomonClinic.specialty).toBe("dermatology");
  expect(bomonClinic.country).toBe("ëŒ€ë§Œ");
  expect(bomonClinic.default_language).toBe("zh-tw");
});
```

### í…ŒìŠ¤íŠ¸ ê²°ê³¼
```
âœ… 3 passed (29.6s)

1ë‹¨ê³„: APIë¡œ ëª¨ë“  ê±°ë˜ì²˜ ì‚­ì œ âœ…
2ë‹¨ê³„: ìƒˆ ê±°ë˜ì²˜ ì¶”ê°€ (bomon-clinic) âœ…
3ë‹¨ê³„: Supabase ë°ì´í„° í™•ì¸ (API í†µí•´) âœ…
```

---

## ğŸ› ë°œê²¬ ë° ìˆ˜ì •ëœ ë²„ê·¸

### ë²„ê·¸ 1: ê±°ë˜ì²˜ ì‚­ì œ ë²„íŠ¼ì´ í˜¸ë²„ ì‹œì—ë§Œ í‘œì‹œ
**ë¬¸ì œ**: ì¹´ë“œì— `group-hover:opacity-100` í´ë˜ìŠ¤ë¡œ ì¸í•´ í˜¸ë²„ ì „ì—ëŠ” ì‚­ì œ ë²„íŠ¼ì´ ë³´ì´ì§€ ì•ŠìŒ

**í•´ê²°**: E2E í…ŒìŠ¤íŠ¸ì—ì„œ ì¹´ë“œì— í˜¸ë²„ í›„ ì‚­ì œ ë²„íŠ¼ í´ë¦­
```typescript
await firstCard.hover();
await page.waitForTimeout(500);
const deleteButton = firstCard.locator('button[title="ì‚­ì œ"]');
await deleteButton.click();
```

### ë²„ê·¸ 2: í…ŒìŠ¤íŠ¸ ë³‘ë ¬ ì‹¤í–‰ìœ¼ë¡œ ì¸í•œ ì¶©ëŒ
**ë¬¸ì œ**: 3ê°œ í…ŒìŠ¤íŠ¸ê°€ ë³‘ë ¬ ì‹¤í–‰ë˜ë©´ì„œ ë°ì´í„° ì¶©ëŒ

**í•´ê²°**: `serial` ëª¨ë“œë¡œ ìˆœì°¨ ì‹¤í–‰
```typescript
test.describe.configure({ mode: "serial" });
```

### ë²„ê·¸ 3: ê±°ë˜ì²˜ê°€ 0ê°œì¼ ë•Œ "ê±°ë˜ì²˜ ì¶”ê°€" ë²„íŠ¼ ì¤‘ë³µ
**ë¬¸ì œ**: "ê±°ë˜ì²˜ ì¶”ê°€" ë²„íŠ¼ê³¼ "ì²« ê±°ë˜ì²˜ ì¶”ê°€í•˜ê¸°" ë²„íŠ¼ì´ ë™ì‹œ í‘œì‹œ

**í•´ê²°**: `.first()` ì‚¬ìš©
```typescript
const addButton = page.locator('button:has-text("ê±°ë˜ì²˜ ì¶”ê°€")').or(
  page.locator('button:has-text("ì²« ê±°ë˜ì²˜ ì¶”ê°€í•˜ê¸°")')
);
await addButton.first().click();
```

---

## ğŸ“Š ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ

### tenants í…Œì´ë¸”
```sql
CREATE TABLE tenants (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL UNIQUE,           -- ê±°ë˜ì²˜ ID (ì˜ë¬¸)
  name_en TEXT,                        -- ì˜ë¬¸ ì´ë¦„
  specialty TEXT,                      -- ì§„ë£Œê³¼ëª©
  is_active BOOLEAN DEFAULT true,      -- í™œì„± ìƒíƒœ
  logo_url TEXT,                       -- ë¡œê³  URL
  settings JSONB DEFAULT '{}',         -- ì„¤ì • (country, default_language ë“±)
  ai_config JSONB DEFAULT '{}',        -- AI ì„¤ì •
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_tenants_name ON tenants(name);
CREATE INDEX idx_tenants_is_active ON tenants(is_active);
```

### settings JSONB êµ¬ì¡°
```json
{
  "default_language": "zh-tw",
  "country": "ëŒ€ë§Œ"
}
```

### ai_config JSONB êµ¬ì¡°
```json
{
  "model": "gpt-4",
  "preferred_model": "gpt-4",
  "enabled": true,
  "auto_response_enabled": true,
  "confidence_threshold": 0.85,
  "system_prompt": "",
  "escalation_keywords": []
}
```

---

## ğŸ” ê¶Œí•œ ë° ë³´ì•ˆ

### API ì¸ì¦
- Supabase Service Role Key ì‚¬ìš©
- `createServiceClient()` í—¬í¼ í•¨ìˆ˜ë¡œ ì¸ì¦ëœ í´ë¼ì´ì–¸íŠ¸ ìƒì„±

### ë°ì´í„° ê²€ì¦
- `name` í•„ìˆ˜ í•„ë“œ ê²€ì¦
- ì§„ë£Œê³¼ëª© enum ê²€ì¦
- AI ì„¤ì • ê¸°ë³¸ê°’ ìë™ ìƒì„±

---

## ğŸš€ ë°°í¬ ë° ëª¨ë‹ˆí„°ë§

### ë°°í¬ í™˜ê²½
- **í”„ë¡œë•ì…˜**: https://csflow.vercel.app
- **Supabase**: PostgreSQL + pgvector

### ëª¨ë‹ˆí„°ë§ ì§€í‘œ
- ì´ ê±°ë˜ì²˜ ìˆ˜
- í™œì„± ê±°ë˜ì²˜ ë¹„ìœ¨
- ê±°ë˜ì²˜ë³„ ëŒ€í™” ìˆ˜
- AI ì •í™•ë„ í‰ê· 
- ì—ìŠ¤ì»¬ë ˆì´ì…˜ìœ¨

---

## ğŸ“ ì‚¬ìš© ì˜ˆì‹œ

### ê±°ë˜ì²˜ ì¶”ê°€
1. `/tenants` í˜ì´ì§€ ì ‘ì†
2. "ê±°ë˜ì²˜ ì¶”ê°€" ë²„íŠ¼ í´ë¦­
3. í¼ ì…ë ¥:
   - ê±°ë˜ì²˜ ID: `bomon-clinic`
   - í‘œì‹œ ì´ë¦„: `ì²­ë‹´ë´„ì˜¨ì˜ì›`
   - ì§„ë£Œê³¼ëª©: `í”¼ë¶€ê³¼`
   - êµ­ê°€: `ëŒ€ë§Œ`
   - ê¸°ë³¸ ì–¸ì–´: `ä¸­æ–‡ (å°ç£)`
4. "ë“±ë¡" ë²„íŠ¼ í´ë¦­
5. ëª©ë¡ì—ì„œ ìƒˆ ê±°ë˜ì²˜ í™•ì¸

### AI ì„¤ì • ìˆ˜ì •
1. ê±°ë˜ì²˜ ì¹´ë“œì— ë§ˆìš°ìŠ¤ í˜¸ë²„
2. "AI ì„¤ì •" ë²„íŠ¼ (ë‡Œ ì•„ì´ì½˜) í´ë¦­
3. ë‹¤ì´ì–¼ë¡œê·¸ì—ì„œ ì„¤ì • ìˆ˜ì •:
   - ëª¨ë¸ ì„ íƒ
   - ì‹ ë¢°ë„ ì„ê³„ê°’ ì¡°ì •
   - ìë™ ì‘ëŒ€ í† ê¸€
   - ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ì…ë ¥
   - ì—ìŠ¤ì»¬ë ˆì´ì…˜ í‚¤ì›Œë“œ ì¶”ê°€
4. "ì €ì¥" ë²„íŠ¼ í´ë¦­

---

## ğŸ”„ í–¥í›„ ê°œì„  ì‚¬í•­

### 1. ë²Œí¬ ì‘ì—…
- [x] CSV ì¼ê´„ ì—…ë¡œë“œ
- [x] CSV ë‹¤ìš´ë¡œë“œ
- [ ] ì„ íƒí•œ ê±°ë˜ì²˜ ì¼ê´„ ì‚­ì œ
- [ ] ì„ íƒí•œ ê±°ë˜ì²˜ ì¼ê´„ ìˆ˜ì •

### 2. ê³ ê¸‰ í•„í„°ë§
- [ ] ì§„ë£Œê³¼ëª©ë³„ í•„í„°
- [ ] êµ­ê°€ë³„ í•„í„°
- [ ] í™œì„±/ë¹„í™œì„± í•„í„°
- [ ] AI ì •í™•ë„ ë²”ìœ„ í•„í„°

### 3. ìƒì„¸ í†µê³„
- [ ] ê±°ë˜ì²˜ë³„ ìƒì„¸ ëŒ€ì‹œë³´ë“œ
- [ ] ì‹œê°„ëŒ€ë³„ í™œë™ ê·¸ë˜í”„
- [ ] ì±„ë„ë³„ ë©”ì‹œì§€ ë¶„í¬
- [ ] ê³ ê° ë§Œì¡±ë„ íŠ¸ë Œë“œ

### 4. AI ì„¤ì • ê³ ë„í™”
- [ ] ê±°ë˜ì²˜ë³„ ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿
- [ ] A/B í…ŒìŠ¤íŠ¸ ê¸°ëŠ¥
- [ ] ë‹¤ì¤‘ ëª¨ë¸ ì¡°í•© (ì•™ìƒë¸”)
- [ ] ìë™ í•™ìŠµ ë° ìµœì í™”

---

## ğŸ“ ë¬¸ì˜ ë° ì§€ì›

**ê°œë°œíŒ€**: CSFlow Development Team
**ìµœì¢… í…ŒìŠ¤íŠ¸**: 2026-02-03
**ë²„ì „**: 1.0.0

---

## âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸

- [x] API êµ¬í˜„ ì™„ë£Œ
- [x] UI ì»´í¬ë„ŒíŠ¸ êµ¬í˜„ ì™„ë£Œ
- [x] E2E í…ŒìŠ¤íŠ¸ ì‘ì„± ë° í†µê³¼
- [x] ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ê²€ì¦
- [x] ë²„ê·¸ ìˆ˜ì • ì™„ë£Œ
- [x] ë¬¸ì„œí™” ì™„ë£Œ
- [ ] ì„±ëŠ¥ ìµœì í™”
- [ ] ì ‘ê·¼ì„± ê°œì„ 
- [ ] ë‹¤êµ­ì–´ ì§€ì› í™•ëŒ€
